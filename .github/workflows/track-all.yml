name: Track Traffic for All Public Repos

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  collect-traffic:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout tracker repo
        uses: actions/checkout@v4

      - name: Verify repos.txt presence
        run: |
          echo "🗂️ Listing current directory:"
          ls -R .
          echo ""
          echo "📄 Checking repos.txt content:"
          if [ -f repos.txt ]; then
            cat repos.txt
          else
            echo "❌ repos.txt not found at repository root!"
            exit 1
          fi

      - name: Fetch traffic for all repos
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TRAFFIC_TOKEN }}
        run: |
          set -euo pipefail
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "📅 Fetching traffic at $DATE"
          mkdir -p data
          REPO_COUNT=0
          SUCCESS_COUNT=0

          # Normalize Windows line endings (CRLF → LF)
          dos2unix repos.txt 2>/dev/null || true

          while IFS= read -r REPO || [ -n "$REPO" ]; do
            # Skip empty or commented lines
            [[ -z "$REPO" || "$REPO" == \#* ]] && continue

            echo "➡️ Attempting to fetch data for repo: '$REPO'"
            REPO_COUNT=$((REPO_COUNT + 1))
            mkdir -p "data/$REPO"

            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/traffic/views" \
              -o "data/$REPO/views.json"

            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/traffic/clones" \
              -o "data/$REPO/clones.json"

            if grep -q '"message":' "data/$REPO/views.json"; then
              echo "⚠️ Failed to fetch $REPO (permission or token issue)"
              head -n 3 "data/$REPO/views.json"
              continue
            fi

            {
              echo "{"
              echo "  \"repo\": \"$REPO\","
              echo "  \"date\": \"$DATE\","
              echo "  \"views\": $(cat data/$REPO/views.json),"
              echo "  \"clones\": $(cat data/$REPO/clones.json)"
              echo "}"
            } > "data/$REPO/traffic-$DATE.json"

            echo "✅ Successfully fetched $REPO"
            SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
          done < repos.txt

          echo ""
          echo "📊 Summary:"
          echo "  Total repos listed: $REPO_COUNT"
          echo "  Successfully fetched: $SUCCESS_COUNT"

          if [ "$REPO_COUNT" -eq 0 ]; then
            echo "❌ No repositories found in repos.txt (empty or unreadable)."
            exit 1
          elif [ "$SUCCESS_COUNT" -eq 0 ]; then
            echo "⚠️ None of the repositories returned valid data."
            echo "   - Ensure token is a *classic* PAT with 'repo' scope."
            exit 0
          fi


      - name: Commit updated stats
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add data/
          git commit -m "Traffic update $(date -u +'%Y-%m-%d')" || echo "No changes"
          git push
